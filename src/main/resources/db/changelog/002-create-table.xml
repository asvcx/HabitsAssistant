<?xml version="1.0" encoding="UTF-8" ?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        https://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.5.xsd"
        logicalFilePath="db/changelog.xml">

        <changeSet id="002-create-table" author="asvcx">

            <createTable tableName="users" schemaName="habits_model_schema" remarks="Table for user accounts">
                <column name="UserID" type="BIGINT" remarks="Identifier of the user">
                    <constraints primaryKey="true" nullable="false"/>
                </column>
                <column name="UserName" type="VARCHAR(255)" remarks="Name or alias of the user"/>
                <column name="Password" type="VARCHAR(255)" remarks="Password for the user account"/>
                <column name="Email" type="VARCHAR(255)" remarks="User email address">
                    <constraints unique="true" nullable="false"/>
                </column>
                <column name="Blocked" type="BOOLEAN" remarks="Indicates whether the user account is blocked"/>
                <column name="AccessLevel" type="habits_model_schema.access_level" remarks="Determines access to administrative features"/>
            </createTable>

            <createTable tableName="habits" schemaName="habits_model_schema" remarks="Table for habits of users">
                <column name="HabitID" type="BIGINT" remarks="Identifier of the habit">
                    <constraints primaryKey="true" nullable="false"/>
                </column>
                <column name="UserID" type="BIGINT" remarks="Identifier of the user associated with the habit">
                    <constraints nullable="false"/>
                </column>
                <column name="Title" type="VARCHAR(255)" remarks="Title of the habit">
                    <constraints nullable="false"/>
                </column>
                <column name="Description" type="VARCHAR(255)" remarks="Description of the habit"/>
                <column name="Period" type="INT" remarks="Period for completing the habit in days">
                    <constraints nullable="false"/>
                </column>
                <column name="StartDate" type="TIMESTAMP WITHOUT TIME ZONE" remarks="Start date of the habit"/>
            </createTable>

            <createTable tableName="completion_dates" schemaName="habits_model_schema" remarks="Table for completion dates of habits">
                <column name="UserID" type="BIGINT" remarks="Identifier of the user associated with completed habit">
                    <constraints nullable="false"/>
                </column>
                <column name="Title" type="VARCHAR(255)" remarks="Title of the completed habit">
                    <constraints nullable="false"/>
                </column>
                <column name="CompletionDate" type="TIMESTAMP WITHOUT TIME ZONE" remarks="Date when the habit was completed">
                    <constraints nullable="false"/>
                </column>
            </createTable>

            <addPrimaryKey
                    constraintName="pk_completion_dates"
                    schemaName="habits_model_schema"
                    tableName="completion_dates"
                    columnNames="UserID,Title,CompletionDate"
            />

            <addUniqueConstraint
                    constraintName="uq_habits_UserID_Title"
                    tableName="habits"
                    columnNames="UserID,Title"
                    schemaName="habits_model_schema"/>

            <addForeignKeyConstraint
                    constraintName="fk_habits_UserID"
                    referencedTableSchemaName="habits_model_schema"
                    baseTableSchemaName="habits_model_schema"
                    baseTableName="habits"
                    baseColumnNames="UserID"
                    referencedTableName="users"
                    referencedColumnNames="UserID"
                    onUpdate="CASCADE"
                    onDelete="CASCADE"
            />

            <addForeignKeyConstraint
                    constraintName="fk_completion_dates_HabitID"
                    referencedTableSchemaName="habits_model_schema"
                    baseTableSchemaName="habits_model_schema"
                    baseTableName="completion_dates"
                    baseColumnNames="Title,UserID"
                    referencedTableName="habits"
                    referencedColumnNames="Title,UserID"
                    onUpdate="CASCADE"
                    onDelete="CASCADE"
            />

        </changeSet>

</databaseChangeLog>